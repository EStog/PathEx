<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pathex.managing.manager &mdash; PathEx 0.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> PathEx
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generalities/index.html">Generalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../semantics/index.html">Semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../references.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/pathex.html">pathex package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PathEx</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>pathex.managing.manager</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pathex.managing.manager</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="kn">from</span> <span class="nn">pathex.adts.containers.ordered_set</span> <span class="kn">import</span> <span class="n">OrderedSet</span>
<span class="kn">from</span> <span class="nn">pathex.adts.singleton</span> <span class="kn">import</span> <span class="n">singleton</span>
<span class="kn">from</span> <span class="nn">pathex.expressions.expression</span> <span class="kn">import</span> <span class="n">Expression</span>
<span class="kn">from</span> <span class="nn">pathex.expressions.nary_operators.concatenation</span> <span class="kn">import</span> <span class="n">Concatenation</span>
<span class="kn">from</span> <span class="nn">pathex.expressions.nary_operators.intersection</span> <span class="kn">import</span> <span class="n">Intersection</span>
<span class="kn">from</span> <span class="nn">pathex.expressions.nary_operators.union</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">pathex.expressions.terms.empty_word</span> <span class="kn">import</span> <span class="n">EMPTY_WORD</span>
<span class="kn">from</span> <span class="nn">pathex.machines.decomposers.decomposer</span> <span class="kn">import</span> <span class="n">DecomposerMatch</span>

<span class="kn">from</span> <span class="nn">.tag</span> <span class="kn">import</span> <span class="n">Tag</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Manager&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="Manager"><a class="viewcode-back" href="../../../API/pathex.managing.manager.html#pathex.managing.manager.Manager">[docs]</a><span class="k">class</span> <span class="nc">Manager</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A generic abstract manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@singleton</span>
    <span class="k">class</span> <span class="nc">_WaitingLabelsFigure</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The instance of this class is used to represent future labels to be matched with. The idea is to use an abstract replacement object that is to be concretized with the current waiting-labels expression.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="n">Expression</span><span class="p">,</span> <span class="n">decomposer</span><span class="p">:</span> <span class="n">DecomposerMatch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_waiting_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WaitingLabelsFigure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expression</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="n">Intersection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_waiting_labels</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">ManagerDecomposer</span><span class="p">(</span><span class="n">decomposer</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="n">waiting_label</span><span class="p">:</span> <span class="nb">object</span>
            <span class="n">waiting_labels_figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WaitingLabelsFigure</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">_waiting_labels_visitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">):</span>
                <span class="c1"># return a visitor to the current waiting-labels expression</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                    <span class="n">Concatenation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waiting_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_labels_figure</span><span class="p">))</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">_populate_transformer</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_populate_transformer</span><span class="p">()</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_transform</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_WaitingLabelsFigure</span><span class="p">,</span>
                                        <span class="bp">cls</span><span class="o">.</span><span class="n">_waiting_labels_visitor</span><span class="p">)</span>

        <span class="c1"># Just in case ``machine`` has some attributes:</span>
        <span class="n">decomposer</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">decomposer</span><span class="p">)</span>

        <span class="c1"># Expand ``machine.branch`` with ``_waiting_labels_visitor``:</span>
        <span class="n">decomposer</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">ManagerDecomposer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_decomposer</span><span class="p">:</span> <span class="n">ManagerDecomposer</span> <span class="o">=</span> <span class="n">decomposer</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_when_requested_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_when_matched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">label_info</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_when_not_matched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
                          <span class="n">label_info</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span> <span class="o">...</span>

<div class="viewcode-block" id="Manager.match"><a class="viewcode-back" href="../../../API/pathex.managing.manager.html#pathex.managing.manager.Manager.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; This method is used to notify to the manager the presence of a given label.</span>

<span class="sd">        The manager then see if this label is allowed by checking if the internal expression can generate the given label.</span>
<span class="sd">        If the label is allowed or not, a respective action is taken.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (object): The label to check for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">label_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when_requested_match</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_advance</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when_matched</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">label_info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when_not_matched</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">label_info</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">new_alternatives</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="c1"># the waiting-labels expression is setted as a sequence consisting of the current label to be matched, followed by the rest of the labels that are to be matched</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decomposer</span><span class="o">.</span><span class="n">waiting_label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="n">alts</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_expression</span><span class="p">])</span>
        <span class="k">while</span> <span class="n">alts</span><span class="p">:</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="n">alts</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="c1"># print(exp)</span>
            <span class="k">for</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">head</span> <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                    <span class="n">new_alternatives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">head</span> <span class="ow">is</span> <span class="n">EMPTY_WORD</span><span class="p">:</span>
                    <span class="n">alts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_alternatives</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expression</span> <span class="o">=</span> <span class="n">Union</span><span class="p">(</span><span class="n">new_alternatives</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Manager.register"><a class="viewcode-back" href="../../../API/pathex.managing.manager.html#pathex.managing.manager.Manager.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decorator to mark a method as a region.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag (Tag): A tag to mark the given funcion with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">wrapped</span><span class="p">):</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">enter</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">exit</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">x</span>
            <span class="k">return</span> <span class="n">f</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manager.region"><a class="viewcode-back" href="../../../API/pathex.managing.manager.html#pathex.managing.manager.Manager.region">[docs]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="n">Tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Context manager to mark a piece of code as a region.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag (Tag): A tag to mark the corresponding block with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">enter</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">exit</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2021, Ernesto Soto GÃ³mez.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>